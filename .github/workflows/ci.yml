name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check project directory
      id: check_dir
      run: |
        echo "Checking for project directory..."
        echo "Current directory: $(pwd)"
        echo "Available directories:"
        ls -la
        echo ""
        
        # Check if pom.xml is in root
        if [ -f "pom.xml" ]; then
          echo "✅ Found pom.xml in root directory"
          echo "PROJECT_DIR=." >> $GITHUB_ENV
          echo "✅ Using root directory as project directory"
        elif [ -d "pomodorotimer-app" ]; then
          echo "✅ Found: pomodorotimer-app"
          echo "Directory contents:"
          ls -la pomodorotimer-app/ | head -10
          if [ -f "pomodorotimer-app/pom.xml" ]; then
            echo "✅ pom.xml found in pomodorotimer-app/"
            echo "PROJECT_DIR=./pomodorotimer-app" >> $GITHUB_ENV
          else
            echo "❌ pom.xml not found in pomodorotimer-app/"
            exit 1
          fi
        elif [ -d "pomodorotimertimertimer-app" ]; then
          echo "⚠️ Found: pomodorotimertimertimer-app (old name)"
          echo "Renaming to pomodorotimer-app..."
          mv pomodorotimertimertimer-app pomodorotimer-app
          echo "✅ Renamed successfully"
          if [ -f "pomodorotimer-app/pom.xml" ]; then
            echo "✅ pom.xml found!"
            echo "PROJECT_DIR=./pomodorotimer-app" >> $GITHUB_ENV
          else
            echo "❌ pom.xml not found after rename!"
            exit 1
          fi
        else
          echo "❌ Project directory not found!"
          echo "Searching for pom.xml..."
          find . -name "pom.xml" -type f 2>/dev/null | head -5
          echo ""
          echo "Available directories:"
          ls -la
          exit 1
        fi
        echo ""
        echo "Project directory set to: $PROJECT_DIR"
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        echo "Building project..."
        mvn clean compile
        echo "✅ Build successful!"
      
    - name: Run tests
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        echo "Running tests..."
        mvn test || {
          echo "❌ Tests failed!"
          echo "=== Test Failure Details ==="
          if [ -d target/surefire-reports ]; then
            echo "=== All Test Reports ==="
            find target/surefire-reports -name "*.txt" -exec echo "=== {} ===" \; -exec cat {} \;
            echo ""
            echo "=== Failed Test Summary ==="
            find target/surefire-reports -name "*.txt" | while read file; do
              if grep -q "FAILURE\|ERROR" "$file"; then
                echo "Failed test: $file"
                head -50 "$file"
                echo "---"
              fi
            done
          else
            echo "No surefire-reports directory found"
          fi
          exit 1
        }
        echo "✅ All tests passed!"
      
    - name: Generate JaCoCo coverage report
      working-directory: ${{ env.PROJECT_DIR }}
      if: always()
      run: |
        echo "Generating JaCoCo coverage report..."
        mvn jacoco:report
        echo "✅ Coverage report generated!"
        echo "Checking for HTML report..."
        if [ -f target/site/jacoco/index.html ]; then
          echo "✅ HTML report found at: target/site/jacoco/index.html"
        else
          echo "⚠️ HTML report not found, checking for XML..."
          ls -la target/site/jacoco/ || echo "Jacoco directory not found"
        fi
      
    - name: Generate Javadoc
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        echo "Generating Javadoc..."
        mvn javadoc:javadoc
        echo "✅ Javadoc generated!"
      
    - name: Package application
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        echo "Packaging application..."
        mvn package -DskipTests
        echo "✅ Package successful!"
      
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: ${{ env.PROJECT_DIR }}/target/site/jacoco/**
        if-no-files-found: ignore
          
    - name: Upload Javadoc
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: javadoc
        path: ${{ env.PROJECT_DIR }}/target/javadoc/**
        if-no-files-found: ignore
