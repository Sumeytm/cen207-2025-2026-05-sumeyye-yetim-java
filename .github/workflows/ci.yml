name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      working-directory: ./pomodorotimer-app
      run: |
        echo "Building project..."
        mvn clean compile
        echo "✅ Build successful!"
      
    - name: Run tests
      working-directory: ./pomodorotimer-app
      run: |
        echo "Running tests..."
        mvn test || {
          echo "❌ Tests failed!"
          echo "=== Test Failure Details ==="
          if [ -d target/surefire-reports ]; then
            echo "=== All Test Reports ==="
            find target/surefire-reports -name "*.txt" -exec echo "=== {} ===" \; -exec cat {} \;
            echo ""
            echo "=== Failed Test Summary ==="
            find target/surefire-reports -name "*.txt" | while read file; do
              if grep -q "FAILURE\|ERROR" "$file"; then
                echo "Failed test: $file"
                head -50 "$file"
                echo "---"
              fi
            done
          else
            echo "No surefire-reports directory found"
          fi
          exit 1
        }
        echo "✅ All tests passed!"
      
    - name: Generate JaCoCo coverage report
      working-directory: ./pomodorotimer-app
      if: always()
      run: |
        echo "Generating JaCoCo coverage report..."
        mvn jacoco:report
        echo "✅ Coverage report generated!"
        echo "Checking for HTML report..."
        if [ -f target/site/jacoco/index.html ]; then
          echo "✅ HTML report found at: target/site/jacoco/index.html"
        else
          echo "⚠️ HTML report not found, checking for XML..."
          ls -la target/site/jacoco/ || echo "Jacoco directory not found"
        fi
      
    - name: Generate Javadoc
      working-directory: ./pomodorotimer-app
      run: |
        echo "Generating Javadoc..."
        mvn javadoc:javadoc
        echo "✅ Javadoc generated!"
      
    - name: Package application
      working-directory: ./pomodorotimer-app
      run: |
        echo "Packaging application..."
        mvn package -DskipTests
        echo "✅ Package successful!"
      
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: pomodorotimer-app/target/site/jacoco/**
        if-no-files-found: ignore
          
    - name: Upload Javadoc
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: javadoc
        path: pomodorotimer-app/target/javadoc/**
        if-no-files-found: ignore
